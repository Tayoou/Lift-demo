<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preview Sandbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: { colors: { clifford: "#da373d" } } },
      };
    </script>

    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background-color: #ffffff;
      }
      #root {
        width: 100%;
        min-height: 100vh;
      }
      .error-box {
        padding: 1rem;
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #f87171;
        border-radius: 0.5rem;
        margin: 1rem;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      const rootElement = document.getElementById("root");
      let reactRoot = null;

      // ğŸ”¥ å…³é”®ä¿®å¤ 1: æŠŠ React çš„æ‰€æœ‰ Hook æ³¨å…¥åˆ°å…¨å±€
      // è¿™æ ·ç”¨æˆ·ä»£ç é‡Œçš„ useState() å°±èƒ½ç›´æ¥è¿è¡Œï¼Œè€Œä¸éœ€è¦å†™ React.useState()
      if (window.React) {
        Object.keys(window.React).forEach((key) => {
          window[key] = window.React[key];
        });
      }

      window.addEventListener("message", (event) => {
        const { type, code } = event.data;
        if (type === "RENDER") {
          // è¿™é‡ŒåŠ ä¸€ä¸ªç®€å•çš„é˜²æŠ–æˆ–å»¶è¿Ÿï¼Œç¡®ä¿ Babel åŠ è½½å®Œæˆ
          if (typeof Babel === "undefined") {
            setTimeout(() => window.postMessage(event.data, "*"), 100);
            return;
          }
          renderCode(code);
        }
      });

      function renderCode(rawCode) {
        try {
          // æ¸…é™¤æ—§é”™è¯¯
          // rootElement.innerHTML = ""; // è¿™ä¸€è¡Œå…ˆæ³¨é‡Šæ‰ï¼Œè®© React è‡ªå·±å¤„ç†é‡ç»˜

          // 1. ä»£ç æ¸…æ´—
          let processedCode = rawCode
            .replace(/import\s+.*?from\s+['"].*?['"];?/g, "") // åˆ  import
            .replace(/export\s+default\s+/g, ""); // åˆ  export default

          // 2. æ™ºèƒ½ä¿®æ­£ï¼šç¡®ä¿ç»„ä»¶æœ‰åå­—
          // å¾ˆå¤šæ—¶å€™ AI å†™ const ProductFeatureCard = ... æˆ‘ä»¬éœ€è¦æ•è·è¿™ä¸ªåå­—
          // æˆ–è€…å¦‚æœæ˜¯ function App() ...

          // æˆ‘ä»¬æ„å»ºä¸€ä¸ªåŒ…è£¹è„šæœ¬ï¼Œä¸ä»…æ‰§è¡Œä»£ç ï¼Œè¿˜è´Ÿè´£æŠŠç»„ä»¶æŒ‚è½½å‡ºæ¥
          // ğŸ”¥ å…³é”®ä¿®å¤ 2: ä¸å†è®© eval è¿”å›ç»„ä»¶ï¼Œè€Œæ˜¯è®© eval å†…éƒ¨ç›´æ¥å®šä¹‰å˜é‡
          const codeToRun = `
            // è¿è¡Œç”¨æˆ·çš„ä»£ç 
            ${processedCode}

            // --- ä¸‹é¢æ˜¯è‡ªåŠ¨æŸ¥æ‰¾ç»„ä»¶çš„é€»è¾‘ ---
            // ä¼˜å…ˆçº§ï¼šApp > ProductFeatureCard > ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„å‡½æ•°ç»„ä»¶
            let TargetComponent = null;

            if (typeof App !== 'undefined') TargetComponent = App;
            else if (typeof ProductFeatureCard !== 'undefined') TargetComponent = ProductFeatureCard;
            else if (typeof Component !== 'undefined') TargetComponent = Component;
            else {
                // æ­¤æ—¶ä»£ç å·²ç»æ‰§è¡Œï¼Œå°è¯•æ‰¾ä»»ä½•å¯èƒ½çš„ç»„ä»¶å
                // è¿™é‡Œæˆ‘ä»¬å‡è®¾ AI é€šå¸¸ä¼šç”¨è¿™å‡ ä¸ªåå­—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåç»­å¯ä»¥åŠ æ›´å¤æ‚çš„éå† window é€»è¾‘
            }
            
            TargetComponent; // è¿”å›ç»™ eval
          `;

          // 3. Babel ç¼–è¯‘
          const compiledCode = Babel.transform(codeToRun, {
            presets: ["react"],
          }).code;

          // 4. æ‰§è¡Œå¹¶è·å–ç»„ä»¶
          const Component = eval(compiledCode);

          if (!Component) {
            throw new Error(
              "æ— æ³•æ‰¾åˆ°å¯æ¸²æŸ“çš„ç»„ä»¶ã€‚è¯·ç¡®ä¿ä»£ç ä¸­å®šä¹‰äº† 'App' æˆ– 'ProductFeatureCard' ç»„ä»¶ã€‚"
            );
          }

          // 5. æŒ‚è½½ React
          if (!reactRoot) {
            reactRoot = ReactDOM.createRoot(rootElement);
          }
          reactRoot.render(React.createElement(Component));
        } catch (err) {
          console.error("Preview Render Error:", err);
          rootElement.innerHTML = `<div class="error-box"><strong>æ¸²æŸ“é”™è¯¯:</strong><br/>${err.message}<br/><br/>(è¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†å †æ ˆ)</div>`;
        }
      }
    </script>
  </body>
</html>
